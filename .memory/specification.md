# テトリスライクゲーム仕様書

## 1. ゲーム概要

このプロジェクトは、TypeScriptとReactを使用して構築されたテトリスライクなブロック落下パズルゲームです。プレイヤーは様々な形のブロックを操作し、水平なラインを完成させることでスコアを獲得します。

## 2. ゲームルール

- 様々な形のブロック（テトロミノ）が画面上部から落下します。
- プレイヤーはブロックを左右に移動、回転、素早く落下（ソフトドロップ）、または一気に落下（ハードドロップ）させることができます。
- プレイヤーは現在のブロックを一時的に保持（ホールド）し、後で使うことができます。
- ブロックが水平ラインを完全に埋めると、そのラインは消去され、スコアが加算されます。
- ブロックが画面上部に積み上がり、新しいブロックが出現できなくなるとゲームオーバーとなります。

## 3. ゲーム機能

- **ブロックの移動**: 左右の矢印キーでブロックを水平移動。
- **ブロックの回転**: 上矢印キーでブロックを時計回りに回転（基本的なWall Kickを含む）。
- **ソフトドロップ**: 下矢印キーでブロックを通常より速く落下。
- **ハードドロップ**: スペースキーでブロックを一瞬で接地させる。
- **ホールド**: ShiftキーまたはCキーで現在のブロックをホールドエリアに保持。ホールド中のブロックと入れ替える（1ターンに1回まで）。
- **スコア表示**: 現在のスコアを表示。ライン消去やハードドロップで加算。
- **レベル表示**: 現在のレベルを表示。
- **ライン数表示**: 消去したラインの合計数を表示。
- **レベルアップ**: 10ライン消去するごとにレベルが上昇し、ブロックの落下速度が増加。
- **Nextブロックプレビュー**: 次に出現するブロックを**5個**まで表示。
- **落下予測表示 (ゴーストピース)**: 現在のブロックがどこに着地するかを予測し、ボード上に薄く表示（**現在実装中、表示未解決**）。
- **ゲームの一時停止と再開**: Pキーでゲームを一時停止/再開。
- **ゲームオーバー表示**: ゲームオーバー時にメッセージを表示。
- **リスタート機能**: Rキーまたはボタンでゲームを最初からやり直す。

## 4. コンポーネント構造

実際の実装では、以下のコンポーネント構造を採用しています：

```
App
├── GameBoard（ゲームボードの表示、ゴーストピース表示）
├── InfoPanel（スコア、レベル、ライン、Nextキュー、ホールド表示）
└── Controls（開始/一時停止、リスタートボタン）
```

### 4.1 ファイル構造

```
/src
├── components/
│   ├── GameBoard.tsx（ゲームボードコンポーネント）
│   ├── InfoPanel.tsx（情報パネルコンポーネント）
│   └── Controls.tsx（コントロールコンポーネント）
├── hooks/
│   └── useGameLogic.ts（ゲームロジックのカスタムフック）
├── types.ts（型定義）
├── utils.ts（ユーティリティ関数、定数）
├── App.tsx（メインコンポーネント）
├── App.css（スタイル定義）
├── index.css（グローバルスタイル）
└── main.tsx（エントリーポイント）
```

## 5. データモデル

### 5.1 ゲーム状態 (`GameState`)

```typescript
interface GameState {
  grid: number[][];       // ゲームボードの状態（0: 空, 1-7: ブロック, 8: ゴーストピース）
  currentBlock: Block;    // 現在操作中のブロック
  nextBlocks: Block[];    // 次に出現するブロックのキュー (5個)
  heldBlock: Block | null; // ホールド中のブロック
  canHold: boolean;       // 現在のターンでホールド可能か
  score: number;          // 現在のスコア
  level: number;          // 現在のレベル
  lines: number;          // 消去したライン数
  isGameOver: boolean;    // ゲームオーバー状態
  isPaused: boolean;      // 一時停止状態
}
```

### 5.2 ブロックモデル (`Block`)

```typescript
interface Block {
  shape: number[][];      // ブロックの形状（2次元配列、値はブロックタイプ）
  position: {           // ブロックの左上の基準点の現在位置
    x: number;
    y: number;
  };
  type: number;           // ブロックの種類（1-7）
}
```

### 5.3 ブロックの種類

7種類の標準的なテトロミノを実装します（形状データは`utils.ts`で定義）：
- 1: I型（水色）
- 2: J型（青色）
- 3: L型（オレンジ色）
- 4: O型（黄色）
- 5: S型（緑色）
- 6: T型（紫色）
- 7: Z型（赤色）

## 6. ゲームロジック

### 6.1 メインゲームループ

- 一定間隔（レベルに応じて変化）で `TICK` アクションが発行され、ブロックが1マス下に移動 (`MOVE_DOWN` 相当）。
- ブロックが他のブロックまたは底に接触して下に移動できなくなったら、その位置に固定。
- 固定後、水平ラインが完成しているか確認。
- 完成したラインを消去し、上のブロックを下にずらし、スコアとライン数を加算。
- 固定時にホールド可能状態 (`canHold`) をリセット (`true` に)。
- Nextキューから新しいブロックを `currentBlock` に設定し、キューに新しいブロックを追加。
- 新しいブロックが初期位置で既に他のブロックと衝突する場合、ゲームオーバー。

### 6.2 衝突検出 (`isValidPosition`)

- ブロックの移動や回転の**前**に、移動/回転後の位置が有効かチェック。
- チェック対象：
    - ボードの左右の壁、底。
    - 他の固定されたブロック（`grid` 上の値が 0 または 8 以外）。
- ゴーストピース（値 8）とは衝突しない。
- 回転時には、まず回転後の位置を確認し、無効な場合は左右にずらして配置可能か試行する（Wall Kick）。

### 6.3 スコア計算

- 1ライン消去：100点 × 現在のレベル
- 2ライン同時消去：300点 × 現在のレベル
- 3ライン同時消去：500点 × 現在のレベル
- 4ライン同時消去（テトリス）：800点 × 現在のレベル
- ハードドロップ：落下したマス数に応じたボーナス点（例: 2点/マス）を加算。

### 6.4 レベル進行

- 合計ライン数が10の倍数に達するごとにレベルアップ (`level = floor(lines / 10) + 1`)。
- レベルが上がると `calculateDropTime` によりブロックの自動落下間隔が短くなる（最小値あり）。

## 7. 技術仕様

- フロントエンド：React (v18+) + TypeScript
- 開発環境：Vite
- スタイリング：CSS（`App.css` にてコンポーネント固有スタイル、`index.css` にてグローバルスタイル、CSS変数使用）
- 状態管理：React Hooks (`useReducer`, `useEffect`, `useCallback`, `useState`, `useMemo`)
- キーボード入力処理：`window.addEventListener('keydown', ...)` を `useGameLogic` 内で設定。
- アニメーション：基本的な描画更新のみ（CSS transitions は現在未使用）。
- レスポンシブデザイン：メディアクエリ（`@media (max-width: 768px)`）で簡易対応。

### 7.1 実装の詳細

#### 状態管理
- `useGameLogic` カスタムフックがゲーム状態 (`state`) と更新関数 (`dispatch`) を提供。
- `gameReducer` が `state` と `action` を受け取り、**状態不変性**を守りながら新しい `state` を返す。
- `useEffect` でキーボードリスナーの設定・解除、および自動落下タイマー（`setInterval`）の管理を行う。
- `useMemo` を `GameBoard` で使用し、`grid` と `currentBlock` から描画用の `displayGrid` を計算する際の最適化を行う。

#### キー操作
- `←` / `→`: `MOVE_LEFT` / `MOVE_RIGHT` アクションを発行。
- `↑`: `ROTATE` アクションを発行。
- `↓`: `MOVE_DOWN` アクションを発行。
- `スペース`: `HARD_DROP` アクションを発行。
- `Shift` / `C`: `HOLD` アクションを発行。
- `P`: `PAUSE` / `RESUME` アクションを発行。
- `R`: `RESTART` アクションを発行。

#### UI設計
- ダークテーマベース。
- `GameBoard`: ゲーム盤面と操作中のブロック、ゴーストピースを表示。
- `InfoPanel`:
    - スコア、レベル、ライン数を表示。
    - **ホールドエリア**: ホールド中のブロックを表示。ホールド不可状態も示す。
    - **Nextキューエリア**: 次の5つのブロックを表示。
    - 操作方法のリストを表示。
    - ゲームオーバー/一時停止メッセージを表示。
- `Controls`: 開始/一時停止ボタン、リスタートボタンを提供。

## 8. 将来の拡張可能性

- ハイスコア保存機能（Local Storageなど）
- 効果音（ブロック移動、回転、接地、ライン消去、ゲームオーバーなど）
- T-Spinなどの高度なテクニック判定とスコアリング
- より洗練されたWall Kick / SRS（Super Rotation System）の実装
- 設定画面（キーコンフィグ、落下速度調整など）
- モバイル対応強化（タッチ操作）
- マルチプレイヤーモード
