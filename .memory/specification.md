# テトリスライクゲーム仕様書 (更新: 2025-04-13)

## 1. ゲーム概要

このプロジェクトは、TypeScriptとReactを使用して構築されたテトリスライクなブロック落下パズルゲームです。プレイヤーは様々な形のブロック（テトロミノ）を操作し、水平なラインを完成させることでスコアを獲得します。ブロックの出現には7-bag Randomizerアルゴリズムを採用しています。

## 2. ゲームルール

-   7種類のテトロミノが、7種類1セット（袋）の中からランダムな順序で選択され、画面上部から落下します。
-   プレイヤーはブロックを左右に移動、回転（時計回り・反時計回り）、素早く落下（ソフトドロップ）、または一気に落下（ハードドロップ）させることができます。
-   プレイヤーは現在のブロックを一時的に保持（ホールド）し、後で使うことができます（1ターンに1回まで）。
-   ブロックが水平ラインを完全に埋めると、そのラインは消去され、スコアが加算されます。
-   ブロックが画面上部に積み上がり、新しいブロックが出現できなくなるとゲームオーバーとなります。

## 3. ゲーム機能

-   **ブロックの移動**: `←` / `H` / `S` キーで左、`→` / `L` / `G` キーで右にブロックを水平移動。
-   **ブロックの回転**:
    -   `↑` / `F` / `J` キーで時計回りに回転。
    -   `Z` / `K` / `D` キーで反時計回りに回転。
    -   回転時には基本的なWall Kick（左右へのずらし試行）を実装。
-   **ソフトドロップ**: `↓` / `N` / `V` キーでブロックを通常より速く落下。
-   **ハードドロップ**: `スペース` キーでブロックを一瞬で接地させる。
-   **ホールド**: `C` / `M` キーで現在のブロックをホールドエリアに保持。ホールド中のブロックと入れ替える（1ターンに1回まで）。ホールド不可状態はUI上で視覚的に示される。
-   **スコア表示**: 現在のスコアを表示。ライン消去やハードドロップで加算。
-   **レベル表示**: 現在のレベルを表示。
-   **ライン数表示**: 消去したラインの合計数を表示。
-   **レベルアップ**: 10ライン消去するごとにレベルが上昇し、ブロックの落下速度が増加。
-   **Nextブロックプレビュー**: 次に出現するブロックを**5個**まで表示。
-   **落下予測表示 (ゴーストピース)**: 現在のブロックがどこに着地するかを予測し、ボード上に薄い枠線で表示（**実装済み**）。
-   **ゲームの一時停止と再開**: `P` キーでゲームを一時停止/再開。ボタン操作も可能。
-   **ゲームオーバー表示**: ゲームオーバー時にメッセージを表示。
-   **リスタート機能**: `R` キーまたはボタンでゲームを最初からやり直す。

## 4. コンポーネント構造

```
App
├── HoldDisplay (ホールドブロック表示)
│   └── BlockDisplay (ブロック描画)
├── GameBoard (ゲームボードの表示、ゴーストピース表示)
├── NextQueueDisplay (Nextブロックキュー表示)
│   └── BlockDisplay (ブロック描画) * 複数
├── InfoPanel (スコア、レベル、ライン、操作方法、メッセージ表示)
└── Controls (開始/一時停止、リスタートボタン)

(useGameLogic フックが状態とロジックを管理)
```

### 4.1 ファイル構造

```
/src
├── components/
│   ├── BlockDisplay.tsx      # 汎用ブロック表示コンポーネント
│   ├── Controls.tsx          # 操作ボタンコンポーネント
│   ├── GameBoard.tsx         # ゲームボードコンポーネント
│   ├── HoldDisplay.tsx       # ホールド表示コンポーネント
│   ├── InfoPanel.tsx         # 情報パネルコンポーネント
│   └── NextQueueDisplay.tsx  # Nextキュー表示コンポーネント
├── hooks/
│   └── useGameLogic.ts       # ゲームロジックのカスタムフック
├── types.ts                  # 型定義
├── utils.ts                  # ユーティリティ関数、定数
├── App.css                   # アプリケーション固有スタイル
├── App.tsx                   # メインアプリケーションコンポーネント
├── index.css                 # グローバルスタイル
├── main.tsx                  # エントリーポイント
└── vite-env.d.ts           # Vite環境型定義
```

## 5. データモデル

### 5.1 ゲーム状態 (`GameState`)

```typescript
interface GameState {
  grid: number[][];       // ゲームボードの状態（0: 空, 1-7: ブロック, 8: ゴーストピース）
  currentBlock: Block;    // 現在操作中のブロック
  nextBlocks: Block[];    // 次に出現するブロックのキュー (5個)
  heldBlock: Block | null; // ホールド中のブロック
  canHold: boolean;       // 現在のターンでホールド可能か
  score: number;          // 現在のスコア
  level: number;          // 現在のレベル
  lines: number;          // 消去したライン数
  isGameOver: boolean;    // ゲームオーバー状態
  isPaused: boolean;      // 一時停止状態
  // --- 7-bag randomizer 用の状態 ---
  currentBag: number[];   // 現在使用中のブロック種類IDの袋
  nextBag: number[];      // 次に使用するブロック種類IDの袋
}
```

### 5.2 ブロックモデル (`Block`)

```typescript
interface Block {
  shape: number[][];      // ブロックの形状（2次元配列、値はブロックタイプ）
  position: {           // ブロックの左上の基準点の現在位置
    x: number;
    y: number;
  };
  type: number;           // ブロックの種類（1-7）
}
```

### 5.3 ブロックの種類

7種類の標準的なテトロミノを実装します（形状データは`utils.ts`で定義）：
- 1: I型（水色）
- 2: J型（青色）
- 3: L型（オレンジ色）
- 4: O型（黄色）
- 5: S型（緑色）
- 6: T型（紫色）
- 7: Z型（赤色）

## 6. ゲームロジック

### 6.1 メインゲームループ

-   一定間隔（レベルに応じて変化）で `TICK` アクションが発行され、ブロックが1マス下に移動 (`MOVE_DOWN` 相当）。
-   ブロックが他のブロックまたは底に接触して下に移動できなくなったら、その位置に固定。
-   固定後、水平ラインが完成しているか確認。
-   完成したラインを消去し、上のブロックを下にずらし、スコアとライン数を加算。
-   固定時にホールド可能状態 (`canHold`) をリセット (`true` に)。
-   Nextキューの先頭を `currentBlock` に設定。7-bag randomizer の仕組みに従い、袋（`currentBag`, `nextBag`）を更新し、Nextキューに新しいブロックを追加。
-   新しいブロックが初期位置で既に他のブロックと衝突する場合、ゲームオーバー。

### 6.2 衝突検出 (`isValidPosition`)

-   ブロックの移動や回転の**前**に、移動/回転後の位置が有効かチェック。
-   チェック対象：
    -   ボードの左右の壁、底。
    -   他の固定されたブロック（`grid` 上の値が 0 または 8 以外）。
-   ゴーストピース（値 8）とは衝突しない（描画時に考慮）。
-   回転時には、まず回転後の位置を確認し、無効な場合は `tryWallKick` 関数により左右に最大2マスずらして配置可能か試行する（基本的なWall Kick）。

### 6.3 スコア計算

-   1ライン消去：100点 × 現在のレベル
-   2ライン同時消去：300点 × 現在のレベル
-   3ライン同時消去：500点 × 現在のレベル
-   4ライン同時消去（テトリス）：800点 × 現在のレベル
-   ハードドロップ：落下したマス数 × 2点 のボーナス点を加算。

### 6.4 レベル進行

-   合計ライン数が10の倍数に達するごとにレベルアップ (`level = floor(lines / 10) + 1`)。
-   レベルが上がると `calculateDropTime` によりブロックの自動落下間隔が短くなる（最小値 100ms）。

## 7. 技術仕様

-   フロントエンド：React (v18+) + TypeScript
-   開発環境：Vite
-   スタイリング：CSS（`App.css` にてコンポーネント固有スタイル、`index.css` にてグローバルスタイル、CSS変数使用、CSS Gridによるレイアウト）
-   状態管理：React Hooks (`useReducer`, `useEffect`, `useCallback`, `useState`, `useMemo`) を中心に `useGameLogic` カスタムフック内で実装。
-   キーボード入力処理：`window.addEventListener('keydown', ...)` を `useGameLogic` 内で設定。
-   アニメーション：基本的な描画更新のみ。
-   レスポンシブデザイン：メディアクエリ（`@media (max-width: 900px)`）で1カラムレイアウトに切り替え。

### 7.1 実装の詳細

#### 状態管理
-   `useGameLogic` カスタムフックがゲーム状態 (`state`) と状態更新のためのディスパッチ関数 (`dispatch`) を提供。
-   `gameReducer` が現在の `state` と発行された `action` を受け取り、**状態不変性**を守りながら新しい `state` オブジェクトを生成して返す。
-   `useEffect` でキーボードイベントリスナーの設定・解除、および自動落下タイマー（`setInterval`）の管理を行う。レベルや一時停止状態に応じてタイマー間隔 (`dropTime`) を動的に変更。
-   `useMemo` を `GameBoard` で使用し、`grid`, `currentBlock`, `isGameOver` から描画用の `displayGrid`（ゴーストピース含む）を計算する際の不要な再計算を防止。
-   `React.memo` を `GameBoard` に適用し、props が変更されない限り再レンダリングをスキップ。

#### キー操作
-   `←` / `H` / `S` : `MOVE_LEFT` アクション。
-   `→` / `L` / `G` : `MOVE_RIGHT` アクション。
-   `↑` / `F` / `J` : `ROTATE` アクション (時計回り)。
-   `Z` / `K` / `D` : `ROTATE_COUNTER_CLOCKWISE` アクション (反時計回り)。
-   `↓` / `N` / `V` : `MOVE_DOWN` アクション (ソフトドロップ)。
-   `スペース`: `HARD_DROP` アクション。
-   `C` / `M`: `HOLD` アクション。
-   `P`: `PAUSE` / `RESUME` アクション。
-   `R`: `RESTART` アクション。
-   キー入力ハンドラ (`handleKeyDown`) 内で、ゲームオーバー状態や一時停止状態に応じてアクションの発行を制御。

#### UI設計
-   ダークテーマベース。
-   CSS Grid (`game-layout`) を使用した4カラムレイアウト（Hold | GameBoard | Next | Info+Controls）。
    -   画面幅が狭い場合 (900px以下) は1カラムレイアウトに変化。
-   `HoldDisplay`: 左カラムにホールド中のブロックを表示。`BlockDisplay` を使用。ホールド不可時は背景色で示す。
-   `GameBoard`: 中央左にゲーム盤面を表示。操作中のブロックとゴーストピース（点線枠）も描画。
-   `NextQueueDisplay`: 中央右に次の5つのブロックを縦に表示。`BlockDisplay` を使用。
-   `InfoPanel`: 右カラム上部にスコア、レベル、ライン数、操作方法リスト、ゲームオーバー/一時停止メッセージを表示。
-   `Controls`: 右カラム下部に開始/一時停止ボタン、リスタートボタンを提供。
-   `BlockDisplay`: ホールドとNextキューで使われる、4x4グリッド内にブロックを中央揃えで表示する汎用コンポーネント。

## 8. 将来の拡張可能性

-   ハイスコア保存機能（Local Storageなど）
-   効果音（ブロック移動、回転、接地、ライン消去、ゲームオーバーなど）
-   T-Spinなどの高度なテクニック判定とスコアリング
-   より洗練されたWall Kick / SRS（Super Rotation System）の実装
-   設定画面（キーコンフィグ、落下速度調整など）
-   モバイル対応強化（タッチ操作）
-   マルチプレイヤーモード
